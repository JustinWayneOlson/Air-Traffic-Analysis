<head>
   <script src="https://d3js.org/d3.v3.min.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.js"></script>
   <script src="js/jquery.datetimepicker.full.min.js"></script>
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
   <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACUlehJQDDBT85PlM_JzIm_rc8Z0iO4dU&callback=initMap"></script>
   <script src='https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js'></script>
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous"/>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet"/>
   <link href="css/jquery.datetimepicker.min.css" rel="stylesheet"/>
   <link href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css" rel="stylesheet"></link>
   <style>
   html, body,
    #map {
         width: 100%;
         height: 75%;
         margin: 0;
         padding: 0;
       }

       .link {
         stroke: #ccc;
         stroke-width: 1.5px;
       }

       .stations,
       .stations svg {
         position: absolute;
       }

       .stations svg {
         width: 1200px;
         height: 600px;
         padding-right: 100px;
         font: 12px sans-serif;
       }

       .stations circle {
         fill: brown;
         stroke: black;
         stroke-width: 1.5px;
       }
       .navbar-logo {
         height: 36px;
       }
     .my-legend .legend-title {
       text-align: left;
       margin-bottom: 5px;
       font-weight: bold;
       font-size: 90%;
       }
     .my-legend .legend-scale ul {
       margin: 0;
       margin-bottom: 5px;
       padding: 0;
       float: left;
       list-style: none;
       }
     .my-legend .legend-scale ul li {
       font-size: 80%;
       list-style: none;
       margin-left: 0;
       line-height: 18px;
       margin-bottom: 2px;
       }
     .my-legend ul.legend-labels li span {
       display: block;
       float: left;
       height: 16px;
       width: 30px;
       margin-right: 5px;
       margin-left: 0;
       border: 1px solid #999;
       }
     .my-legend .legend-source {
       font-size: 70%;
       color: #999;
       clear: both;
       }
     .my-legend a {
       color: #777;
       background: #ECEEEF;
       }
   </style>
</head>
<body id="main">
<nav class="navbar navbar-toggleable-md navbar-light bg-faded">
  <button id='navbar-dropdown' class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a href="http://www.northropgrumman.com/Pages/default.aspx">
     <img class="navbar-brand navbar-logo" src='/img/ng.png'></img>
  </a>
  <a href="http://www.colorado.edu/cs/senior-project">
     <img class="navbar-brand navbar-logo" src='/img/cu.png'></img>
  </a>
  <a class="navbar-brand" href='/'>Air Traffic Analysis</a>
  <a class="navbar-brand" href='routing'>Routing</a>
  <a class="navbar-brand" href="about">About</a>

   <div class="collapse navbar-collapse" id="navbarSupportedContent">
         <div class="container-fluid">
            <div class='jumbotron'>
               <div class='container-fluid' id='selections-container'>
                  <div class='row'>
                     <div class='col-xs-6'>
                         <button class='btn btn-success' id="plot-airports">Plot Airports</button>
                        <p>Visualize and view air traffic data through airports.</p>
                     </div>
                  </div>
                  <div class='row'>
                     <div class='col-xs-4'>
                         <label for="date_start">Date Start: </label>
                         <input type="text" id="date_start">
                         <br>
                         <label for="date_end">Date End: </label>
                         <input type="text"  id="date_end">
                     </div>
                     <div class='col-xs-4'>
                         <label for="Origin">Source Airport: </label>
                         <input type="text" value="LAS" id="Origin" multiple='multiple'>
                         <br>
                         <label for="Dest">Destination Airport: </label>
                         <input type="text" id="Dest" multiple='multiple'>
                     </div>
                     <div class='col-xs-4'>
                         <label for="Carrier">Airline: </label>
                         <input type="text" value="NK" id="Carrier" multiple='multiple'>
                         <br>
                         <label for="FlightNum">Flight Number: </label>
                         <input type="text" id="FlightNum">
                     </div>
                  </div>
                  <div class='row'>
                     <input id='verbose-toggle' type='checkbox'></input>
                     <label for='verbose-toggle'>Toggle Verbose Output
                  </div>
                  <div class='row'>
                     <input id='path-toggle' type='checkbox'></input>
                     <label for='path-toggle'>Toggle Flight Paths
                  </div>
               </div>
            </div>
         </div>
      </div>
  </div>
</nav>
<div id='legend' class='my-legend'>
   <div class='legend-title'>Airport Delay Frequency</div>
   <div class='legend-scale'>
     <ul class='legend-labels'>
       <li><span style='background:white;'></span>Source Airport</li>
       <li><span style='background:green;'></span>< 50% Delay</li>
       <li><span style='background:yellow;'></span>> 50% Delay</li>
       <li><span style='background:red;'></span>> 60% Delay</li>
     </ul>
   </div>
   </div>

</div>
   <div id="map"></div>
   <div id="verbose-container"></div>
   <table id='info-table' class="display compact" cellspacing='0', width='100%'>
      <thead>
         <tr>
            <th>Airport Code</th>
            <th>Total Flights</th>
            <th>NAS Delayed Flights</th>
            <th>NAS Delay Percentage</th>
            <th>NAS Delay Minutes</th>
            <th>Carrier Delayed Flights</th>
            <th>Carrier Delay Percentage</th>
            <th>Carrier Delay Minutes</th>
            <th>Weather Delayed Flights</th>
            <th>Weather Delay Percentage</th>
            <th>Weather Delay Minutes</th>
            <th>Security Delayed Flights</th>
            <th>Security Delay Percentage</th>
            <th>Security Delay Minutes</th>
            <th>Late Aircraft Delayed Flights</th>
            <th>Late Aircraft Delay Percentage</th>
            <th>Late Aircraft Delay Minutes</th>

         </tr>
      </thead>
      <tbody>
      </tbody>
   </table>
   <script>
   $(document).ready(function(){
      $('#legend').hide();
      $('#date_start').datetimepicker(
         {
            timepicker:false,
            format: 'm/d/Y'
         }
      );

      $('#date_end').datetimepicker(
         {
            timepicker:false,
            format: 'm/d/Y'
         }
      );

      $('#info-table').DataTable();

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Origin",
            success: function(data){
               $('#Origin').select2({
                  data:data['response'],
                  placeholder: "Select an option"
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Dest",
            success: function(data){
               $('#Dest').select2({
                  data:data['response'],
                  placeholder: "Select an option"
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Carrier",
            success: function(data){
               $('#Carrier').select2({
                  data:data['response'],
                  placeholder: "Select an option"
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );
   });

   $("#plot-airports").click(function (event) {
      $('#map').append('<img id="loading" src="/img/loading.gif"></img>');
      var data = {}
      $('#selections-container').find('input').each(function(index,value){
         if($(value).val() && $(value).attr('type') != 'checkbox')
         {
            if($(value).attr('multiple')=='multiple')
            {
            console.log("multiple")
               data[$(value).attr('id')] = $(value).val().split(',');
            }
            else
            {
               data[$(value).attr('id')] = $(value).val();
            }
         }
         else if($(value).attr('type') == 'checkbox')
         {
            data['verbose_toggle'] = $('#verbose-toggle').prop('checked');
            data['path_toggle'] = $('#path-toggle').prop('checked');
         }
      });
    console.log(data);
    var form_query = JSON.stringify(data);

    $.ajax(
    {
      url: "/display-airports",
      type: "POST",
      data: form_query,

      success: function(data) {
         if(data['verbose'])
         {
            console.log(data['verbose']);
            $('#verbose-container').append('<p>' + data['verbose'] + '</p>')
         }
         if(!(data['links']))
         {
            $('#navbar-dropdown').click();
            $('#legend').show();
            $('#loading').remove();
            var map = new google.maps.Map(d3.select("#map").node(), {
                  zoom: 4,
                  center: new google.maps.LatLng(39.8282, -98.5795),
                  mapTypeId: google.maps.MapTypeId.TERRAIN,
                  styles: [
                            {
                              "elementType": "geometry",
                              "stylers": [
                                {
                                  "color": "#212121"
                                }
                              ]
                            },
                            {
                              "elementType": "labels.icon",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#757575"
                                }
                              ]
                            },
                            {
                              "elementType": "labels.text.stroke",
                              "stylers": [
                                {
                                  "color": "#212121"
                                }
                              ]
                            },
                            {
                              "featureType": "administrative",
                              "elementType": "geometry",
                              "stylers": [
                                {
                                  "color": "#757575"
                                },
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "administrative.country",
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#9e9e9e"
                                }
                              ]
                            },
                            {
                              "featureType": "administrative.land_parcel",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "administrative.locality",
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#bdbdbd"
                                }
                              ]
                            },
                            {
                              "featureType": "administrative.neighborhood",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "poi",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "poi",
                              "elementType": "labels.text",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "poi",
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#757575"
                                }
                              ]
                            },
                            {
                              "featureType": "poi.park",
                              "elementType": "geometry",
                              "stylers": [
                                {
                                  "color": "#181818"
                                }
                              ]
                            },
                            {
                              "featureType": "poi.park",
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#616161"
                                }
                              ]
                            },
                            {
                              "featureType": "poi.park",
                              "elementType": "labels.text.stroke",
                              "stylers": [
                                {
                                  "color": "#1b1b1b"
                                }
                              ]
                            },
                            {
                              "featureType": "road",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "road",
                              "elementType": "geometry.fill",
                              "stylers": [
                                {
                                  "color": "#2c2c2c"
                                }
                              ]
                            },
                            {
                              "featureType": "road",
                              "elementType": "labels",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "road",
                              "elementType": "labels.icon",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "road",
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#8a8a8a"
                                }
                              ]
                            },
                            {
                              "featureType": "road.arterial",
                              "elementType": "geometry",
                              "stylers": [
                                {
                                  "color": "#373737"
                                }
                              ]
                            },
                            {
                              "featureType": "road.highway",
                              "elementType": "geometry",
                              "stylers": [
                                {
                                  "color": "#3c3c3c"
                                }
                              ]
                            },
                            {
                              "featureType": "road.highway.controlled_access",
                              "elementType": "geometry",
                              "stylers": [
                                {
                                  "color": "#4e4e4e"
                                }
                              ]
                            },
                            {
                              "featureType": "road.local",
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#616161"
                                }
                              ]
                            },
                            {
                              "featureType": "transit",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "transit",
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#757575"
                                }
                              ]
                            },
                            {
                              "featureType": "water",
                              "elementType": "geometry",
                              "stylers": [
                                {
                                  "color": "#000000"
                                }
                              ]
                            },
                            {
                              "featureType": "water",
                              "elementType": "labels.text",
                              "stylers": [
                                {
                                  "visibility": "off"
                                }
                              ]
                            },
                            {
                              "featureType": "water",
                              "elementType": "labels.text.fill",
                              "stylers": [
                                {
                                  "color": "#3d3d3d"
                                }
                              ]
                            }
                          ]
             });
            var geoJSON;
            var request;
            var gettingData = false;
            var openWeatherMapKey = "b6c5711b8dcd855fced4510aa21dbecc";

            function initialize(map) {
              google.maps.event.addListener(map, 'idle', checkIfDataRequested);

              map.data.addListener('click', function(event) {
                infowindow.setContent(
                  "<img src=" + event.feature.getProperty("icon") + ">"
                  + "<br /><strong>" + event.feature.getProperty("city") + "</strong>"
                  + "<br />" + event.feature.getProperty("temperature") + "&deg;C"
                  + "<br />" + event.feature.getProperty("weather")
                  );
                infowindow.setOptions({
                  position: {
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng()
                  },
                  pixelOffset: {
                    width: 0,
                    height: -15
                  }
                });
                infowindow.open(map);
              });
            }

            var checkIfDataRequested = function() {
              while (gettingData === true) {
                request.abort();
                gettingData = false;
              }
              getCoords();
            };

            var getCoords = function() {
              var bounds = map.getBounds();
              var NE = bounds.getNorthEast();
              var SW = bounds.getSouthWest();
              getWeather(NE.lat(), NE.lng(), SW.lat(), SW.lng());
            };

            var getWeather = function(northLat, eastLng, southLat, westLng) {
              gettingData = true;
              console.log("Getting weather...");
              var requestString = "http://api.openweathermap.org/data/2.5/box/city?bbox="
                                  + westLng + "," + northLat + ","
                                  + eastLng + "," + southLat + ","
                                  + map.getZoom()
                                  + "&cluster=yes&format=json"
                                  + "&APPID=" + openWeatherMapKey;
              request = new XMLHttpRequest();
              request.onload = processResults;
              request.open("get", requestString, true);
              request.send();
            };

            var processResults = function() {
              console.log(this);
              var results = JSON.parse(this.responseText);
              console.log("Results:");
              console.log(results);
              if (results.list.length > 0) {
                resetData();
                for (var i = 0; i < results.list.length; i++) {
                  geoJSON.features.push(jsonToGeoJson(results.list[i]));
                }
                drawIcons(geoJSON);
              }
            };

            var infowindow = new google.maps.InfoWindow();

            var jsonToGeoJson = function(weatherItem) {
              var feature = {
                type: "Feature",
                properties: {
                  city: weatherItem.name,
                  weather: weatherItem.weather[0].main,
                  temperature: weatherItem.main.temp,
                  icon: "http://openweathermap.org/img/w/"
                          + weatherItem.weather[0].icon + ".png",
                  coordinates: [weatherItem.coord.lon, weatherItem.coord.lat]
                },

                geometry: {
                  type: "Point",
                  coordinates: [weatherItem.coord.lon, weatherItem.coord.lat]
                }
              };

              map.data.setStyle(function(feature) {
                return {
                  icon: {
                    url: feature.getProperty('icon'),
                    anchor: new google.maps.Point(25, 25)
                  }
                };
              });

              return feature;
            };

            var resetData = function() {
              geoJSON = {
                type: "FeatureCollection",
                features: []
              };
              map.data.forEach(function(feature){
                map.data.remove(feature);
              });
            };

            var drawIcons = function(weather) {
              map.data.addGeoJson(geoJSON);
              gettingData = false;
            };

            google.maps.event.addDomListener(window, 'load', initialize(map));



            var overlay = new google.maps.OverlayView();
              overlay.onAdd = function() {
                var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
                  .attr("class", "stations");
                overlay.draw = function() {
                  layer.select('svg').remove();
                  var projection = this.getProjection(),
                    padding = 10;
                  var svg = layer.append("svg")
                    .attr('width', 1200)
                    .attr('height', 600);
                  var node = svg.selectAll(".stations")
                    .data(data.nodes)
                    .enter().append("g")
                    .each(transform)
                    .attr("class", "node")
                    .on('click', moreinfo);
                  node.append("circle")
                    .attr("r", 4.5)
                    .each(setColor)
                    .on('mouseover', someinfo)
                    .on('mouseout', mouseoutofinfo);

                  function latLongToPos(d) {
                    var p = new google.maps.LatLng(d.lat, d.long);
                    p = projection.fromLatLngToDivPixel(p);
                    p.x = p.x - padding;
                    p.y = p.y - padding;
                    return p;
                  }
                  function mouseoutofinfo(){
                     d3.select(this).transition()
                                    .duration(100)
                                    .attr("r",4.5);
                  }
                  function someinfo(){
                     d3.select(this).transition()
                                    .duration(1000)
                                    .attr("r",75);
                  }
                  var table_data = []
                  function moreinfo(){
                    $('.odd').remove();
                    var delay_data = $(this)[0].__data__;
                    $('tbody').append('<tr><td>' + delay_data.Name + '</td><td>' + delay_data.TotalFlights + '</td><td>' + delay_data.NASDelayTot + '</td><td>' + delay_data.NASDelayTot / delay_data.TotalDelayedFlights + '</td><td>' + delay_data.NASDelay + '</td><td>' + delay_data.CarrierDelayTot + '</td><td>' + delay_data.CarrierDelayTot / delay_data.TotalDelayedFlights + '</td><td>' + delay_data.CarrierDelay + '</td><td>' + delay_data.WeatherDelayTot + '</td><td>' + delay_data.WeatherDelayTot / delay_data.TotalDelayedFlights + '</td><td>' + delay_data.WeatherDelay + '</td><td>' + delay_data.SecurityDelayTot + '</td><td>' + delay_data.SecurityDelayTot / delay_data.TotalDelayedFlights + '</td><td>' + delay_data.SecurityDelay + '</th><th>' + delay_data.LateAircraftDelayTot + '</td><td>' + delay_data.LateAircraftDelayTot / delay_data.TotalDelayedFlights + '</td><td>' + delay_data.LateAircraftDelay + '</td></tr>')
                  }
                  function transform(d) {
                    var p = latLongToPos(d);
                    return d3.select(this)
                      .attr("transform", "translate(" + p.x + "," + p.y + ")");
                  }
                  function setColor(d) {
                    return d3.select(this)
                      .style('fill', d.Color)
                  }
                };
              };
              overlay.setMap(map);

               }
            else
            {
               $('#navbar-dropdown').click();
               $('#legend').show();
               $('#loading').remove();
                  var map = new google.maps.Map(d3.select("#map").node(), {
                        zoom: 4,
                        center: new google.maps.LatLng(39.8282, -98.5795),
                        mapTypeId: google.maps.MapTypeId.TERRAIN,
                        styles: [
                               {
                                 "elementType": "geometry",
                                 "stylers": [
                                   {
                                     "color": "#212121"
                                   }
                                 ]
                               },
                               {
                                 "elementType": "labels.icon",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#757575"
                                   }
                                 ]
                               },
                               {
                                 "elementType": "labels.text.stroke",
                                 "stylers": [
                                   {
                                     "color": "#212121"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "administrative",
                                 "elementType": "geometry",
                                 "stylers": [
                                   {
                                     "color": "#757575"
                                   },
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "administrative.country",
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#9e9e9e"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "administrative.land_parcel",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "administrative.locality",
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#bdbdbd"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "administrative.neighborhood",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "poi",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "poi",
                                 "elementType": "labels.text",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "poi",
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#757575"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "poi.park",
                                 "elementType": "geometry",
                                 "stylers": [
                                   {
                                     "color": "#181818"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "poi.park",
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#616161"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "poi.park",
                                 "elementType": "labels.text.stroke",
                                 "stylers": [
                                   {
                                     "color": "#1b1b1b"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road",
                                 "elementType": "geometry.fill",
                                 "stylers": [
                                   {
                                     "color": "#2c2c2c"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road",
                                 "elementType": "labels",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road",
                                 "elementType": "labels.icon",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road",
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#8a8a8a"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road.arterial",
                                 "elementType": "geometry",
                                 "stylers": [
                                   {
                                     "color": "#373737"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road.highway",
                                 "elementType": "geometry",
                                 "stylers": [
                                   {
                                     "color": "#3c3c3c"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road.highway.controlled_access",
                                 "elementType": "geometry",
                                 "stylers": [
                                   {
                                     "color": "#4e4e4e"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "road.local",
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#616161"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "transit",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "transit",
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#757575"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "water",
                                 "elementType": "geometry",
                                 "stylers": [
                                   {
                                     "color": "#000000"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "water",
                                 "elementType": "labels.text",
                                 "stylers": [
                                   {
                                     "visibility": "off"
                                   }
                                 ]
                               },
                               {
                                 "featureType": "water",
                                 "elementType": "labels.text.fill",
                                 "stylers": [
                                   {
                                     "color": "#3d3d3d"
                                   }
                                 ]
                               }
                             ]
                   });
                   var overlay = new google.maps.OverlayView();

                   overlay.onAdd = function() {
                     var layer = d3.select(this.getPanes().overlayLayer).append("div")
                       .attr("class", "stations");

                     overlay.draw = function() {

                       layer.select('svg').remove();

                       var projection = this.getProjection(),
                         padding = 10;

                       var merc_projection = d3.geo.mercator();

                       var svg = layer.append("svg")
                         .attr('width', 1200)
                         .attr('height', 600);

                       var node = svg.selectAll(".stations")
                         .data(data.nodes)
                         .enter().append("g")
                         .each(transform)
                         .attr("class", "node");

                       var link = svg.selectAll(".link")
                         .data(data.links)
                         .enter().append("path")
                         .attr("class", "path")
                         .each(drawlink);

                       node.append("circle")
                         .attr("r", 4.5)
                         .style("fill", "white");

                       node.append("text")
                         .attr("x", 7)
                         .attr("y", 0)
                         .attr("dy", ".31em")
                         .text(function(d) {
                           return d.name;
                         });

                       //Convert GPS coordinates to corresponding div pixels
                       function latLongToPos(d) {
                         var p = new google.maps.LatLng(d.lat, d.long);
                         p = projection.fromLatLngToDivPixel(p);
                         p.x = p.x - padding;
                         p.y = p.y - padding;
                         return p;
                       }

                       //Comput GPS midpoint between source and destination airport
                       function latLongToMidpoint(source, dest) {
                         //half_lat adjusted North by 3 degrees to adjust for curved paths
                         half_lat = (dest.lat + source.lat)/2 + 3;
                         half_lon = (dest.long + source.long)/2;
                         var p = new google.maps.LatLng(half_lat, half_lon);
                         p = projection.fromLatLngToDivPixel(p);
                         p.x = p.x - padding;
                         p.y = p.y - padding;
                         return p;
                       }

                       function transform(d) {
                         var p = latLongToPos(d);
                         return d3.select(this)
                           .attr("transform", "translate(" + p.x + "," + p.y + ")");
                       }

                       //Driver function to draw links between set of 3 points
                       function drawlink(d) {
                         console.log(d);
                         var p1 = latLongToPos(data.nodes[d.source]);
                         var p2 = latLongToMidpoint(data.nodes[d.source], data.nodes[d.target]);
                         var p3 = latLongToPos(data.nodes[d.target]);
                         var lineData = [{"x": p1.x, "y": p1.y},
                                         {"x": p2.x, "y": p2.y},
                                         {"x": p3.x, "y": p3.y}];
                         var lineFunction = d3.svg.line()
                           .x(function(d) { return d.x; })
                           .y(function(d) { return d.y; })
                           .interpolate("basis");

                         d3.select(this)
                           .attr("d", lineFunction(lineData))
                           .style('fill', 'none')
                           .style('stroke', 'yellow');
                       }
                     };
                   };

                   overlay.setMap(map);

               console.log(data);
         }
      },
      error: function(error) {
         $('#loading').remove()
         console.log(error);
      }
    });
   })
   </script>
</body>
