<head>
   <script src="https://d3js.org/d3.v3.min.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.js"></script>
   <script src="js/jquery.datetimepicker.full.min.js"></script>
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
   <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACUlehJQDDBT85PlM_JzIm_rc8Z0iO4dU&callback=initMap"></script>
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet"/>
   <link href="css/jquery.datetimepicker.min.css" rel="stylesheet"/>
   <style>
   html, body,
    #map {
         width: 100%;
         height: 100%;
         margin: 0;
         padding: 0;
       }

       .link {
         stroke: #ccc;
         stroke-width: 1.5px;
       }

       .stations,
       .stations svg {
         position: absolute;
       }

       .stations svg {
         width: 1200px;
         height: 600px;
         padding-right: 100px;
         font: 12px sans-serif;
       }

       .stations circle {
         fill: brown;
         stroke: black;
         stroke-width: 1.5px;
       }

   </style>
</head>
<body id="main">
<nav class="navbar navbar-toggleable-md navbar-light bg-faded">
  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="#">NG</a>
  <a class="navbar-brand" href="#">CU</a>
  <a class="navbar-brand" href="#">Air Traffic Analysis</a>


   <div class="collapse navbar-collapse" id="navbarSupportedContent">
         <div class="container-fluid">
            <div class='jumbotron'>
               <div class='container-fluid' id='selections-container'>
                  <div class='row'>
                     <div class='col-xs-6'>
                         <button class='btn btn-success' id="plot-airports">Plot Airports</button>
                        <p>Visualize and view air traffic data through airports.</p>
                     </div>
                     <div class='col-xs-6'>
                         <button class='btn btn-success' id="plot-flights">Plot Flights</button>
                         <p>Visualize and view air traffic data through individual flights.</p>
                     </div>
                  </div>
                  <div class='row'>
                      <label for="date_start">Date Start: </label>
                      <input type="text" id="date_start" multiple="multiple">
                      <label for="date_end">Date End: </label>
                      <input type="text"  id="date_end" multiple="multiple">
                      <label for="Origin">Source Airport: </label>
                      <input type="text" value="LAS" id="Origin" multiple="multiple">
                      <label for="Dest">Destination Airport: </label>
                      <input type="text" id="Dest" multiple="multiple">
                      <label for="Carrier">Airline: </label>
                      <input type="text" value="NK" id="Carrier" multiple="multiple">
                      <label for="FlightNum">Flight Number: </label>
                      <input type="text" id="FlightNum" multiple="multiple">
                  </div>
               </div>
            </div>
         </div>
      </div>
  </div>
</nav>

   <div id="map"></div>

   <script>
   $(document).ready(function(){

      $('#date_start').datetimepicker(
         {
            timepicker:false,
            format: 'd/m/Y'
         }
      );

      $('#date_end').datetimepicker(
         {
            timepicker:false,
            format: 'd/m/Y'
         }
      );

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Origin",
            success: function(data){
               $('#Origin').select2({
                  data:data['response']
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Dest",
            success: function(data){
               $('#Dest').select2({
                  data:data['response']
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Carrier",
            success: function(data){
               $('#Carrier').select2({
                  data:data['response']
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );
   });

   $("#plot-airports").click(function (event) {
      var map = new google.maps.Map(d3.select("#map").node(), {
            zoom: 4,
            center: new google.maps.LatLng(39.8282, -98.5795),
            mapTypeId: google.maps.MapTypeId.TERRAIN,
            disableDefaultUI: true
       });
      var data = {}
      $('#selections-container').find('input').each(function(index,value){
         if($(value).val())
         {
            data[$(value).attr('id')] = $(value).val();
         }
      });

    var form_query = JSON.stringify(data);

    $.ajax(
    {
      url: "/display-airports",
      type: "POST",
      data: form_query,

      success: function(data) {

      console.log(data);
      var overlay = new google.maps.OverlayView();
        overlay.onAdd = function() {
          var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
            .attr("class", "stations");
          overlay.draw = function() {
            layer.select('svg').remove();
            var projection = this.getProjection(),
              padding = 10;
            var svg = layer.append("svg")
              .attr('width', 1200)
              .attr('height', 600);
            var node = svg.selectAll(".stations")
              .data(data.nodes)
              .enter().append("g")
              .each(transform)
              .attr("class", "node")
              .on('mouseover', displaybox);
            node.append("circle")
              .attr("r", 4.5)
              .each(setColor);
            node.append("text")
              .attr("x", 7)
              .attr("y", 0)
              .attr("dy", ".31em")
              .text(function(d) {
                return d.name;
              });
            function latLongToPos(d) {
              var p = new google.maps.LatLng(d.lat, d.long);
              p = projection.fromLatLngToDivPixel(p);
              p.x = p.x - padding;
              p.y = p.y - padding;
              return p;
            }
            function displaybox(){
               var delay_data = $(this)[0].__data__;
               $('body').append("<span>" + JSON.stringify(delay_data) + "</span>");
            }
            function transform(d) {
              var p = latLongToPos(d);
              return d3.select(this)
                .attr("transform", "translate(" + p.x + "," + p.y + ")");
            }
            function setColor(d) {
              return d3.select(this)
                .style('fill', d.Color)
            }
          };
        };
        overlay.setMap(map);
      },
      error: function(error) {
         console.log(error);
      }
    });
   })


   $("#plot-flights").click(function (event) {
      var map = new google.maps.Map(d3.select("#map").node(), {
            zoom: 4,
            center: new google.maps.LatLng(39.8282, -98.5795),
            mapTypeId: google.maps.MapTypeId.TERRAIN
       });
      var data = {}
      $('#selections-container').find('input').each(function(index,value){
         if($(value).val())
         {
            data[$(value).attr('id')] = $(value).val();
         }
      });

    var form_query = JSON.stringify(data);

    $.ajax(
    {
      url: "/display-flights",
      type: "POST",
      data: form_query,

      success: function(data) {
          var overlay = new google.maps.OverlayView();

          overlay.onAdd = function() {
            var layer = d3.select(this.getPanes().overlayLayer).append("div")
              .attr("class", "stations");

            overlay.draw = function() {

              layer.select('svg').remove();

              var projection = this.getProjection(),
                padding = 10;

              var svg = layer.append("svg")
                .attr('width', 1200)
                .attr('height', 600);

              var node = svg.selectAll(".stations")
                .data(data.nodes)
                .enter().append("g")
                .each(transform)
                .attr("class", "node");

              var link = svg.selectAll(".link")
                .data(data.links)
                .enter().append("line")
                .attr("class", "link")
                .each(drawlink);

              node.append("circle")
                .attr("r", 4.5);

              node.append("text")
                .attr("x", 7)
                .attr("y", 0)
                .attr("dy", ".31em")
                .text(function(d) {
                  return d.name;
                });

              function latLongToPos(d) {
                var p = new google.maps.LatLng(d.lat, d.long);
                p = projection.fromLatLngToDivPixel(p);
                p.x = p.x - padding;
                p.y = p.y - padding;
                return p;
              }

              function transform(d) {
                var p = latLongToPos(d);
                return d3.select(this)
                  .attr("transform", "translate(" + p.x + "," + p.y + ")");
              }

              function drawlink(d) {
                console.log(d);
                var p1 = latLongToPos(data.nodes[d.source]),
                  p2 = latLongToPos(data.nodes[d.target]);
                d3.select(this)
                  .attr('x1', p1.x)
                  .attr('y1', p1.y)
                  .attr('x2', p2.x)
                  .attr('y2', p2.y)
                  .style('fill', 'none')
                  .style('stroke', 'steelblue');
              }
            };
          };

          overlay.setMap(map);

      console.log(data);
      },
      error: function(error) {
         console.log(error);
      }
    });
   })



   </script>
</body>
