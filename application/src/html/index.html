<head>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
   <script src="https://maps.google.com/maps/api/js?key=AIzaSyADmBaNROVdyNdfu2gDybR8DWlzZB_mulo"></script>
   <script src="https://d3js.org/d3.v3.min.js"></script>
<style>

html, body,
 #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .link {
      stroke: #ccc;
      stroke-width: 1.5px;
    }

    .stations,
    .stations svg {
      position: absolute;
    }

    .stations svg {
      width: 1200px;
      height: 600px;
      padding-right: 100px;
      font: 12px sans-serif;
    }

    .stations circle {
      fill: brown;
      stroke: black;
      stroke-width: 1.5px;
    }

</style>
</head>
<body id="main">

   <form>
    Date Start: <input type = "text" id = "date-start">
    Date End: <input type = "text" id = "date-end">
    Airport: <input type = "text" id = "airport">
    Airline: <input type = "text" id = "airline">
    Flight Number: <input type = "text" id = "flight-number">
    <button id = "runajax"> RUN </button>
   </form>

   <br>
   <br>
   <p>Enter a city: </p>
   <input type="text" id="city-input" value="Chicago, IL" >
   <button id='run-get'>Search Airports</button>
   <br>
   <button id='display-airports'>Display Airports</button>
   <br>
   <div id="map"></div>
 
   <script>
   $("#runajax").click(function (event) {
    
    var data =
    {
      date_start: $("#date-start").val(),
      date_end: $("#date-end").val(),
      airline: $("#airline").val(),
      airport: $("#airport").val(),
      flight_num: $("#flight-number").val()
    };

    var form_query = JSON.stringify(data);

    $.ajax(
    {
      url: "/test/",
      type: "POST",
      data: form_query,

      success: function(data) {

        for (var i = 0; i < data.nodes.length; i++){
          alert(data.nodes[i].Name);
        }

        

      },
      error: function() {
        alert("Didn't work");
      }
    });
   })

   $('#display-airports').click(function(){
    var map = new google.maps.Map(d3.select("#map").node(), {
      zoom: 4,
      center: new google.maps.LatLng(39.8282, -98.5795),
      mapTypeId: google.maps.MapTypeId.TERRAIN
    });

    $.ajax({
      type: "GET",
      url: "/display-airports",
      success: function(data){
        console.log(data);

        var overlay = new google.maps.OverlayView();

        overlay.onAdd = function() {
          var layer = d3.select(this.getPanes().overlayLayer).append("div")
            .attr("class", "stations");

          overlay.draw = function() {

            layer.select('svg').remove();

            var projection = this.getProjection(),
              padding = 10;

            var svg = layer.append("svg")
              .attr('width', 1200)
              .attr('height', 600);

            var node = svg.selectAll(".stations")
              .data(data.nodes)
              .enter().append("g")
              .each(transform)
              .attr("class", "node");

            node.append("circle")
              .attr("r", 4.5)

            node.append("text")
              .attr("x", 7)
              .attr("y", 0)
              .attr("dy", ".31em")
              .text(function(d) {
                return d.name;
              });

            function latLongToPos(d) {
              var p = new google.maps.LatLng(d.lat, d.long);
              p = projection.fromLatLngToDivPixel(p);
              p.x = p.x - padding;
              p.y = p.y - padding;
              return p;
            }

            function transform(d) {
              var p = latLongToPos(d);
              return d3.select(this)
                .attr("transform", "translate(" + p.x + "," + p.y + ")");
            }
          };
        };

        overlay.setMap(map);
        
      },
      error: function(error){
        console.log("no")
        console.log(error);
      }
    });
   })

   $('#run-get').click(function(){
      var city = $('#city-input').val();

    // Create the Google Mapâ€¦
    var map = new google.maps.Map(d3.select("#map").node(), {
      zoom: 4,
      center: new google.maps.LatLng(39.8282, -98.5795),
      mapTypeId: google.maps.MapTypeId.TERRAIN
    });

    $.ajax({
         type:"GET",
         url:"/testd3/" + city,
         success: function(data){
          console.log(data)

          var overlay = new google.maps.OverlayView();

          overlay.onAdd = function() {
            var layer = d3.select(this.getPanes().overlayLayer).append("div")
              .attr("class", "stations");

            overlay.draw = function() {

              layer.select('svg').remove();

              var projection = this.getProjection(),
                padding = 10;

              var svg = layer.append("svg")
                .attr('width', 1200)
                .attr('height', 600);

              var node = svg.selectAll(".stations")
                .data(data.nodes)
                .enter().append("g")
                .each(transform)
                .attr("class", "node");

              var link = svg.selectAll(".link")
                .data(data.links)
                .enter().append("line")
                .attr("class", "link")
                .each(drawlink);

              node.append("circle")
                .attr("r", 4.5);

              node.append("text")
                .attr("x", 7)
                .attr("y", 0)
                .attr("dy", ".31em")
                .text(function(d) {
                  return d.name;
                });

              function latLongToPos(d) {
                var p = new google.maps.LatLng(d.lat, d.long);
                p = projection.fromLatLngToDivPixel(p);
                p.x = p.x - padding;
                p.y = p.y - padding;
                return p;
              }

              function transform(d) {
                var p = latLongToPos(d);
                return d3.select(this)
                  .attr("transform", "translate(" + p.x + "," + p.y + ")");
              }

              function drawlink(d) {
                console.log(d);
                var p1 = latLongToPos(data.nodes[d.source]),
                  p2 = latLongToPos(data.nodes[d.target]);
                d3.select(this)
                  .attr('x1', p1.x)
                  .attr('y1', p1.y)
                  .attr('x2', p2.x)
                  .attr('y2', p2.y)
                  .style('fill', 'none')
                  .style('stroke', 'steelblue');
              }
            };
          };

          overlay.setMap(map);

         },
         error: function(error){
            console.log(error);
         }
      });
   });



   </script>
</body>
