<head>
<script src="https://d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.js"></script>
<script src="js/jquery.datetimepicker.full.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet"/>
<link href="css/jquery.datetimepicker.min.css" rel="stylesheet"/>

<style>
html, body,
 #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .link {
      stroke: #ccc;
      stroke-width: 1.5px;
    }

    .stations,
    .stations svg {
      position: absolute;
    }

    .stations svg {
      width: 1200px;
      height: 600px;
      padding-right: 100px;
      font: 12px sans-serif;
    }

    .stations circle {
      fill: brown;
      stroke: black;
      stroke-width: 1.5px;
    }

</style>
</head>
<body id="main">
   <div class='jumbotron'>
      <div class='container-fluid' id='selections-container'>
          <div class='col-xs-4'>
             <div class='row'>
                <label for="start-day-picker">Date Start: </label>
                <input type="text" id="date_start">
             </div>

             <div class='row'>
                <label for="end-day-picker">Date End: </label>
                <input type="text"  id="date_end">
            </div>
             <div class='row'>
                <button class='btn btn-success' id="runajax"> RUN </button>
                <br>
            </div>
          </div>

          <div class='col-xs-4'>
             <div class='row'>
                <label for="airport">Source Airport: </label>
                <input type="text" value="LAS" id="Origin">
             </div>

             <div class='row'>
                <label for="airline">Airline: </label>
                <input type="text" value="NK" id="Carrier">
             </div>
          </div>

          <div class='col-xs-4'>
             <div class='row'>
                <label for="airport">Destination Airport: </label>
                <input type="text" id="Dest">
             </div>

             <div class='row'>
                <label for="flight-number">Flight Number: </label>
                <input type="text" id="FlightNum">
             </div>

         </div>
      </div>
</div>

   <div id="map"></div>

   <script>
   $(document).ready(function(){

      $('#start-day-picker').datetimepicker(
         {
            timepicker:false,
            format: 'd/m/Y'
         }
      );

      $('#end-day-picker').datetimepicker(
         {
            timepicker:false,
            format: 'd/m/Y'
         }
      );

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Origin",
            success: function(data){
               $('#source-airport').select2({
                  data:data['response']
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Dest",
            success: function(data){
               $('#destination-airport').select2({
                  data:data['response']
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );

      $.ajax(
         {
            type: "GET",
            url: "/dropdown-fill/Carrier",
            success: function(data){
               $('#airline').select2({
                  data:data['response']
               });
            },
            error: function(error){
               console.log(error);
            }
         }
      );
   });
   $("#runajax").click(function (event) {
      var data = {}
      $('#selections-container').find('input').each(function(index,value){
         if($(value).val())
         {
            data[$(value).attr('id')] = $(value).val();
         }
      });

    var form_query = JSON.stringify(data);

    $.ajax(
    {
      url: "/test/",
      type: "POST",
      data: form_query,

      success: function(data) {
         console.log(data);

        for (var i = 0; i < data.nodes.length; i++){
          console.log(data.nodes[i].Name);
        }



      },
      error: function(error) {
         console.log(error);
      }
    });
   })

   $('#display-airports').click(function(){
    var map = new google.maps.Map(d3.select("#map").node(), {
      zoom: 4,
      center: new google.maps.LatLng(39.8282, -98.5795),
      mapTypeId: google.maps.MapTypeId.TERRAIN
    });

    $.ajax({
      type: "GET",
      url: "/display-airports",
      success: function(data){
        console.log(data);

        var overlay = new google.maps.OverlayView();

        overlay.onAdd = function() {
          var layer = d3.select(this.getPanes().overlayLayer).append("div")
            .attr("class", "stations");

          overlay.draw = function() {

            layer.select('svg').remove();

            var projection = this.getProjection(),
              padding = 10;

            var svg = layer.append("svg")
              .attr('width', 1200)
              .attr('height', 600);

            var node = svg.selectAll(".stations")
              .data(data.nodes)
              .enter().append("g")
              .each(transform)
              .attr("class", "node");

            node.append("circle")
              .attr("r", 4.5)

            node.append("text")
              .attr("x", 7)
              .attr("y", 0)
              .attr("dy", ".31em")
              .text(function(d) {
                return d.name;
              });

            function latLongToPos(d) {
              var p = new google.maps.LatLng(d.lat, d.long);
              p = projection.fromLatLngToDivPixel(p);
              p.x = p.x - padding;
              p.y = p.y - padding;
              return p;
            }

            function transform(d) {
              var p = latLongToPos(d);
              return d3.select(this)
                .attr("transform", "translate(" + p.x + "," + p.y + ")");
            }
          };
        };

        overlay.setMap(map);

      },
      error: function(error){
        console.log("no")
        console.log(error);
      }
    });
   })

   $('#run-get').click(function(){
      var city = $('#city-input').val();

    // Create the Google Mapâ€¦
    var map = new google.maps.Map(d3.select("#map").node(), {
      zoom: 4,
      center: new google.maps.LatLng(39.8282, -98.5795),
      mapTypeId: google.maps.MapTypeId.TERRAIN
    });

    $.ajax({
         type:"GET",
         url:"/testd3/" + city,
         success: function(data){
          console.log(data)

          var overlay = new google.maps.OverlayView();

          overlay.onAdd = function() {
            var layer = d3.select(this.getPanes().overlayLayer).append("div")
              .attr("class", "stations");

            overlay.draw = function() {

              layer.select('svg').remove();

              var projection = this.getProjection(),
                padding = 10;

              var svg = layer.append("svg")
                .attr('width', 1200)
                .attr('height', 600);

              var node = svg.selectAll(".stations")
                .data(data.nodes)
                .enter().append("g")
                .each(transform)
                .attr("class", "node");

              var link = svg.selectAll(".link")
                .data(data.links)
                .enter().append("line")
                .attr("class", "link")
                .each(drawlink);

              node.append("circle")
                .attr("r", 4.5);

              node.append("text")
                .attr("x", 7)
                .attr("y", 0)
                .attr("dy", ".31em")
                .text(function(d) {
                  return d.name;
                });

              function latLongToPos(d) {
                var p = new google.maps.LatLng(d.lat, d.long);
                p = projection.fromLatLngToDivPixel(p);
                p.x = p.x - padding;
                p.y = p.y - padding;
                return p;
              }

              function transform(d) {
                var p = latLongToPos(d);
                return d3.select(this)
                  .attr("transform", "translate(" + p.x + "," + p.y + ")");
              }

              function drawlink(d) {
                console.log(d);
                var p1 = latLongToPos(data.nodes[d.source]),
                  p2 = latLongToPos(data.nodes[d.target]);
                d3.select(this)
                  .attr('x1', p1.x)
                  .attr('y1', p1.y)
                  .attr('x2', p2.x)
                  .attr('y2', p2.y)
                  .style('fill', 'none')
                  .style('stroke', 'steelblue');
              }
            };
          };

          overlay.setMap(map);

         },
         error: function(error){
            console.log(error);
         }
      });
   });



   </script>
</body>
