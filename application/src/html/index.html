<head>
   <!-- Import jQuery -->
<style>

html, body,
 #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .link {
      stroke: #ccc;
      stroke-width: 1.5px;
    }

    .stations,
    .stations svg {
      position: absolute;
    }

    .stations svg {
      width: 1200px;
      height: 600px;
      padding-right: 100px;
      font: 12px sans-serif;
    }

    .stations circle {
      fill: brown;
      stroke: black;
      stroke-width: 1.5px;
    }

</style>
</head>
<body id="main">
   <p>Enter a city: </p>
   <input type="text" id="city-input" value="Denver" >
   <button id='run-get'>Find City Stuff</button>
   <br>
   <div id="map"></div>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
   <script src="//maps.google.com/maps/api/js?sensor=true"></script>
   <script src="//d3js.org/d3.v3.min.js"></script>
   <script>
   $('#run-get').click(function(){
      var city = $('#city-input').val();

    // Create the Google Mapâ€¦
    var map = new google.maps.Map(d3.select("#map").node(), {
      zoom: 4,
      center: new google.maps.LatLng(39.8282, -98.5795),
      mapTypeId: google.maps.MapTypeId.TERRAIN
    });

    //d3.json("stations.json", function(error, data) {

    $.ajax({
         type:"GET",
         url:"/testd3/" + city,
         success: function(data){

          var overlay = new google.maps.OverlayView();

          overlay.onAdd = function() {
            var layer = d3.select(this.getPanes().overlayLayer).append("div")
              .attr("class", "stations");

            overlay.draw = function() {

              layer.select('svg').remove();

              var projection = this.getProjection(),
                padding = 10;

              var svg = layer.append("svg")
                .attr('width', 1200)
                .attr('height', 600)

              var node = svg.selectAll(".stations")
                .data(data.nodes)
                .enter().append("g")
                .each(transform)
                .attr("class", "node");

              var link = svg.selectAll(".link")
                .data(data.links)
                .enter().append("line")
                .attr("class", "link")
                .each(drawlink);

              node.append("circle")
                .attr("r", 4.5);

              node.append("text")
                .attr("x", 7)
                .attr("y", 0)
                .attr("dy", ".31em")
                .text(function(d) {
                  return d.name;
                });

              function latLongToPos(d) {
                var p = new google.maps.LatLng(d.lat, d.long);
               console.log(d);
                p = projection.fromLatLngToDivPixel(p);
                p.x = p.x - padding;
                p.y = p.y - padding;
                return p;
              }

              function transform(d) {
                var p = latLongToPos(d);
                return d3.select(this)
                  .attr("transform", "translate(" + p.x + "," + p.y + ")");
              }

              function drawlink(d) {
                var p1 = latLongToPos(data.nodes[d.source]),
                  p2 = latLongToPos(data.nodes[d.target]);
                d3.select(this)
                  .attr('x1', p1.x)
                  .attr('y1', p1.y)
                  .attr('x2', p2.x)
                  .attr('y2', p2.y)
                  .style('fill', 'none')
                  .style('stroke', 'steelblue');
              }
            };
          };

          overlay.setMap(map);

         },
         error: function(error){
            console.log(error);
         }
      });
   });



   </script>
</body>
